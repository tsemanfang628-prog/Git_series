<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ProGen AI - Login</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <h1 class="logo">ProGen AI</h1>
      <p class="subtitle">Professional Illustration Generator</p>

      <form id="loginForm">
        <div class="input-group">
          <label for="code">Industry Code</label>
          <input type="text" id="code" placeholder="Enter your unique code" required />
        </div>
        <button type="submit" class="btn-primary btn-block">Log In</button>
      </form>

      <p class="text-center mt-4">
        Don't have a code? <a href="register.html">Create Account</a>
      </p>
      <p class="text-center">
        <a href="admin.html" class="text-sm">Admin Login</a>
      </p>
    </div>
  </div>

  <!-- LOGIN LOGIC (NO EXTERNAL FILE NEEDED) -->
  <script>
    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();

      const enteredCode = document.getElementById('code').value.trim().toUpperCase();
      const pendingCode = localStorage.getItem('pendingCode');
      const tempUser = JSON.parse(localStorage.getItem('tempUser') || '{}');

      // Fresh registration
      if (pendingCode && enteredCode === pendingCode && tempUser.email) {
        saveUserAndLogin(tempUser, enteredCode);
        return;
      }

      // Returning user
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const existingUser = users.find(u => u.code === enteredCode);

      if (existingUser) {
        localStorage.setItem('currentUser', JSON.stringify(existingUser));
        localStorage.removeItem('pendingCode');
        localStorage.removeItem('tempUser');
        window.location.href = 'questionnaire.html';
        return;
      }

      alert('Invalid or expired code. Please register again.');
    });

    function saveUserAndLogin(tempUser, code) {
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      let user = users.find(u => u.email === tempUser.email);

      if (!user) {
        user = { ...tempUser, code, id: Date.now(), credits: 20 };
        users.push(user);
        localStorage.setItem('users', JSON.stringify(users));
      }

      localStorage.setItem('currentUser', JSON.stringify(user));
      localStorage.removeItem('pendingCode');
      localStorage.removeItem('tempUser');
      window.location.href = 'questionnaire.html';
    }
  </script>
</body>
</html>
